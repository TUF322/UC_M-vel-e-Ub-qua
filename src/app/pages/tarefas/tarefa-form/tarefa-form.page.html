<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="tarefa.projetoId ? '/projetos/detalhes/' + tarefa.projetoId : '/projetos'"></ion-back-button>
    </ion-buttons>
    <ion-title>
      {{ isEditMode ? getString('labels.editar') : getString('labels.adicionar') }} 
      {{ getString('labels.tarefas') }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="salvar()" [disabled]="loading">
        <ion-icon slot="icon-only" name="checkmark"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">
        {{ isEditMode ? getString('labels.editar') : getString('labels.adicionar') }} 
        {{ getString('labels.tarefas') }}
      </ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="form-container">
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>A carregar...</p>
    </div>

    <!-- Formulário -->
    <ion-card *ngIf="!loading">
      <ion-card-header>
        <ion-card-title>Informações da Tarefa</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Campo Título -->
        <ion-item>
          <ion-label position="stacked">{{ getString('labels.nome') }} (Título) *</ion-label>
          <ion-input
            [(ngModel)]="tarefa.titulo"
            type="text"
            placeholder="Ex: Estudar para o exame"
            required
          ></ion-input>
        </ion-item>

        <!-- Campo Descrição -->
        <ion-item>
          <ion-label position="stacked">{{ getString('labels.descricao') }}</ion-label>
          <ion-textarea
            [(ngModel)]="tarefa.descricao"
            placeholder="Descrição opcional da tarefa"
            rows="4"
          ></ion-textarea>
        </ion-item>

        <!-- Campo Projeto -->
        <ion-item>
          <ion-label position="stacked">{{ getString('labels.projeto') }} *</ion-label>
          <ion-select [(ngModel)]="tarefa.projetoId" placeholder="Selecione um projeto" [disabled]="!!projetoId">
            <ion-select-option *ngFor="let projeto of projetos" [value]="projeto.id">
              {{ projeto.nome }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Campo Data Limite -->
        <ion-item>
          <ion-label position="stacked">{{ getString('labels.dataLimite') }} *</ion-label>
          <ion-datetime-button datetime="dataLimite"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime
                id="dataLimite"
                [(ngModel)]="tarefa.dataLimite"
                presentation="date"
                [min]="dataMinima"
                [max]="dataMaxima"
              ></ion-datetime>
            </ng-template>
          </ion-modal>
        </ion-item>

        <!-- Campo Hora de Início -->
        <ion-item button (click)="abrirSeletorHora('inicio')">
          <ion-label position="stacked">Hora de Início</ion-label>
          <ion-input
            [value]="formatarHoraParaExibicao(tarefa.horaInicio)"
            placeholder="Selecione a hora"
            readonly
          ></ion-input>
          <ion-icon slot="end" name="time-outline"></ion-icon>
        </ion-item>

        <!-- Campo Hora de Fim -->
        <ion-item button (click)="abrirSeletorHora('fim')">
          <ion-label position="stacked">Hora de Fim (opcional)</ion-label>
          <ion-input
            [value]="formatarHoraParaExibicao(tarefa.horaFim)"
            placeholder="Selecione a hora"
            readonly
          ></ion-input>
          <ion-icon slot="end" name="time-outline"></ion-icon>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Configuração de Notificação -->
    <ion-card *ngIf="!loading">
      <ion-card-header>
        <ion-card-title>Notificação</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Checkbox para ativar/desativar notificações -->
        <ion-item>
          <ion-label>Ativar notificação</ion-label>
          <ion-checkbox [(ngModel)]="notificarAtivo" (ionChange)="alterarTipoNotificacao()"></ion-checkbox>
        </ion-item>

        <!-- Tipo de Notificação (só aparece se ativado) -->
        <ion-item *ngIf="notificarAtivo">
          <ion-label position="stacked">Notificar quando</ion-label>
          <ion-select [(ngModel)]="tipoNotificacao" (ionChange)="alterarTipoNotificacao()">
            <ion-select-option value="30min">30 minutos antes</ion-select-option>
            <ion-select-option value="1hora">1 hora antes</ion-select-option>
            <ion-select-option value="1dia">1 dia antes</ion-select-option>
            <ion-select-option value="custom">Personalizado</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Configuração Custom (só aparece se tipo custom e ativado) -->
        <div *ngIf="notificarAtivo && mostrarConfigCustom">
          <ion-item button (click)="abrirSeletorDataCustom()">
            <ion-label position="stacked">Data da Notificação</ion-label>
            <ion-input
              [value]="dataHoraCustom ? (dataHoraCustom | date:'dd/MM/yyyy') : ''"
              placeholder="Selecione a data"
              readonly
            ></ion-input>
            <ion-icon slot="end" name="calendar-outline"></ion-icon>
          </ion-item>

          <ion-item button (click)="abrirSeletorHoraCustom()">
            <ion-label position="stacked">Hora da Notificação</ion-label>
            <ion-input
              [value]="formatarHoraParaExibicao(horaCustom)"
              placeholder="Selecione a hora"
              readonly
            ></ion-input>
            <ion-icon slot="end" name="time-outline"></ion-icon>
          </ion-item>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Imagem -->
    <ion-card *ngIf="!loading">
      <ion-card-header>
        <ion-card-title>{{ getString('labels.imagem') }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div *ngIf="!imagemPreview" class="sem-imagem">
          <ion-icon name="image-outline" size="large"></ion-icon>
          <p>Nenhuma imagem selecionada</p>
          <ion-button (click)="mostrarOpcoesImagem()" fill="outline">
            <ion-icon slot="start" name="camera"></ion-icon>
            Adicionar Imagem
          </ion-button>
        </div>

        <div *ngIf="imagemPreview" class="com-imagem">
          <img [src]="imagemPreview" alt="Preview" class="imagem-preview" />
          <ion-button expand="block" fill="outline" color="danger" (click)="removerImagem()">
            <ion-icon slot="start" name="trash"></ion-icon>
            Remover Imagem
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Botões de Ação -->
    <div class="actions-container" *ngIf="!loading">
      <ion-button expand="block" (click)="salvar()" [disabled]="loading">
        <ion-icon slot="start" name="checkmark"></ion-icon>
        {{ getString('labels.salvar') }}
      </ion-button>
      <ion-button expand="block" fill="outline" (click)="cancelar()">
        <ion-icon slot="start" name="close"></ion-icon>
        {{ getString('labels.cancelar') }}
      </ion-button>
    </div>
  </div>
</ion-content>
